name: Maintenance

on:
  schedule:
    - cron: '0 8 * * 1' # Weekly on Monday at 8 AM
  workflow_dispatch:

jobs:
  maintenance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Update dependencies
        run: |
          echo "🔧 Updating dependencies..."
          npm update
          echo "✅ Dependencies updated"

      - name: Check for outdated packages
        run: |
          echo "🔧 Checking for outdated packages..."
          npm outdated || echo "📦 All packages are up to date"

      - name: Audit dependencies
        run: |
          echo "🔧 Auditing dependencies..."
          npm audit --audit-level=moderate || echo "⚠️ Some vulnerabilities found"

      - name: Clean and rebuild
        run: |
          echo "🔧 Cleaning and rebuilding..."
          npm run clean
          npm run build
          echo "✅ Clean build completed"

      - name: Run all tests
        run: |
          echo "🔧 Running all tests..."
          npm test
          echo "✅ All tests passed"

      - name: Check code quality
        run: |
          echo "🔧 Checking code quality..."
          npm run lint:check
          npm run format:check
          npm run type-check
          echo "✅ Code quality checks passed"

      - name: Generate maintenance report
        run: |
          echo "## Maintenance Report - $(date)" > maintenance-report.md
          echo "### Actions Performed" >> maintenance-report.md
          echo "- ✅ Dependencies updated" >> maintenance-report.md
          echo "- ✅ Security audit completed" >> maintenance-report.md
          echo "- ✅ Clean build successful" >> maintenance-report.md
          echo "- ✅ All tests passed" >> maintenance-report.md
          echo "- ✅ Code quality maintained" >> maintenance-report.md
          echo "" >> maintenance-report.md
          echo "### Recommendations" >> maintenance-report.md
          echo "- 📦 Consider updating major versions if needed" >> maintenance-report.md
          echo "- 🔒 Address any security vulnerabilities" >> maintenance-report.md
          echo "- 📚 Update documentation if needed" >> maintenance-report.md
          echo "- 🚀 Plan next release" >> maintenance-report.md

      - name: Upload maintenance report
        uses: actions/upload-artifact@v3
        with:
          name: maintenance-report-$(date +%Y%m%d)
          path: maintenance-report.md
          retention-days: 30

      - name: Create maintenance issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('maintenance-report.md', 'utf8');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Maintenance Report - ${new Date().toISOString().split('T')[0]}`,
              body: report,
              labels: ['maintenance', 'automated']
            });

      - name: Notify maintenance completion
        run: |
          echo "🔧 Maintenance completed successfully on $(date)"
          echo "📦 Maintenance report uploaded as artifact"
          echo "📋 Maintenance issue created"
          echo "🗂️ Retention period: 30 days"
