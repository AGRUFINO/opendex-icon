name: Maintenance

on:
  schedule:
    - cron: '0 8 * * 1' # Weekly on Monday at 8 AM
  workflow_dispatch:

jobs:
  maintenance:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Update dependencies
        run: |
          echo "ğŸ”§ Updating dependencies..."
          npm update
          echo "âœ… Dependencies updated"

      - name: Check for outdated packages
        run: |
          echo "ğŸ”§ Checking for outdated packages..."
          npm outdated || echo "ğŸ“¦ All packages are up to date"

      - name: Audit dependencies
        run: |
          echo "ğŸ”§ Auditing dependencies..."
          npm audit --audit-level=moderate || echo "âš ï¸ Some vulnerabilities found"

      - name: Clean and rebuild
        run: |
          echo "ğŸ”§ Cleaning and rebuilding..."
          npm run clean
          npm run build
          echo "âœ… Clean build completed"

      - name: Run all tests
        run: |
          echo "ğŸ”§ Running all tests..."
          npm test
          echo "âœ… All tests passed"

      - name: Check code quality
        run: |
          echo "ğŸ”§ Checking code quality..."
          npm run lint:check
          npm run format:check
          npm run type-check
          echo "âœ… Code quality checks passed"

      - name: Generate maintenance report
        run: |
          echo "## Maintenance Report - $(date)" > maintenance-report.md
          echo "### Actions Performed" >> maintenance-report.md
          echo "- âœ… Dependencies updated" >> maintenance-report.md
          echo "- âœ… Security audit completed" >> maintenance-report.md
          echo "- âœ… Clean build successful" >> maintenance-report.md
          echo "- âœ… All tests passed" >> maintenance-report.md
          echo "- âœ… Code quality maintained" >> maintenance-report.md
          echo "" >> maintenance-report.md
          echo "### Recommendations" >> maintenance-report.md
          echo "- ğŸ“¦ Consider updating major versions if needed" >> maintenance-report.md
          echo "- ğŸ”’ Address any security vulnerabilities" >> maintenance-report.md
          echo "- ğŸ“š Update documentation if needed" >> maintenance-report.md
          echo "- ğŸš€ Plan next release" >> maintenance-report.md

      - name: Upload maintenance report
        uses: actions/upload-artifact@v3
        with:
          name: maintenance-report-$(date +%Y%m%d)
          path: maintenance-report.md
          retention-days: 30

      - name: Create maintenance issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('maintenance-report.md', 'utf8');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Maintenance Report - ${new Date().toISOString().split('T')[0]}`,
              body: report,
              labels: ['maintenance', 'automated']
            });

      - name: Notify maintenance completion
        run: |
          echo "ğŸ”§ Maintenance completed successfully on $(date)"
          echo "ğŸ“¦ Maintenance report uploaded as artifact"
          echo "ğŸ“‹ Maintenance issue created"
          echo "ğŸ—‚ï¸ Retention period: 30 days"
