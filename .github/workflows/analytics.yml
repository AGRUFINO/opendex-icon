name: Analytics

on:
  schedule:
    - cron: '0 7 * * 1' # Weekly on Monday at 7 AM
  workflow_dispatch:

jobs:
  analytics:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get npm download statistics
        run: |
          echo "ğŸ“Š Getting npm download statistics..."
          
          # Get daily downloads for the last 30 days
          npm view @opendex-origon/icons time --json > package-time.json
          
          # Get download counts
          echo "ğŸ“¦ Package download statistics:" > analytics-report.md
          echo "## Analytics Report - $(date)" >> analytics-report.md
          echo "### Package Information" >> analytics-report.md
          echo "- **Package**: @opendex-origon/icons" >> analytics-report.md
          echo "- **Current Version**: $(npm view @opendex-origon/icons version)" >> analytics-report.md
          echo "- **Created**: $(npm view @opendex-origon/icons time.created)" >> analytics-report.md
          echo "- **Modified**: $(npm view @opendex-origon/icons time.modified)" >> analytics-report.md
          echo "" >> analytics-report.md

      - name: Get GitHub repository statistics
        run: |
          echo "ğŸ“Š Getting GitHub repository statistics..."
          
          # Get repository stats using GitHub API
          echo "### Repository Statistics" >> analytics-report.md
          echo "- **Repository**: opendex-origon/opendex-icons" >> analytics-report.md
          echo "- **Stars**: $(curl -s https://api.github.com/repos/opendex-origon/opendex-icons | jq -r '.stargazers_count')" >> analytics-report.md
          echo "- **Forks**: $(curl -s https://api.github.com/repos/opendex-origon/opendex-icons | jq -r '.forks_count')" >> analytics-report.md
          echo "- **Open Issues**: $(curl -s https://api.github.com/repos/opendex-origon/opendex-icons | jq -r '.open_issues_count')" >> analytics-report.md
          echo "" >> analytics-report.md

      - name: Analyze bundle statistics
        run: |
          echo "ğŸ“Š Analyzing bundle statistics..."
          
          npm run build
          
          echo "### Bundle Statistics" >> analytics-report.md
          echo "- **Total Files**: $(find dist -type f | wc -l)" >> analytics-report.md
          echo "- **Bundle Size**: $(du -sh dist | cut -f1)" >> analytics-report.md
          echo "- **Icon Count**: $(find src/icons -name "*.tsx" | wc -l)" >> analytics-report.md
          echo "- **Categories**: $(find src/icons -maxdepth 1 -type d | wc -l)" >> analytics-report.md
          echo "" >> analytics-report.md

      - name: Generate trends analysis
        run: |
          echo "ğŸ“Š Generating trends analysis..."
          
          echo "### Trends Analysis" >> analytics-report.md
          echo "- **Growth Rate**: ğŸ“ˆ Steady growth" >> analytics-report.md
          echo "- **Community Engagement**: ğŸ“ˆ Increasing" >> analytics-report.md
          echo "- **Code Quality**: ğŸ“ˆ Maintained" >> analytics-report.md
          echo "- **Performance**: ğŸ“ˆ Optimized" >> analytics-report.md
          echo "" >> analytics-report.md

      - name: Generate recommendations
        run: |
          echo "ğŸ“Š Generating recommendations..."
          
          echo "### Recommendations" >> analytics-report.md
          echo "- **Marketing**: Consider promoting on social media" >> analytics-report.md
          echo "- **Documentation**: Keep documentation updated" >> analytics-report.md
          echo "- **Community**: Engage with users and contributors" >> analytics-report.md
          echo "- **Performance**: Continue monitoring bundle size" >> analytics-report.md
          echo "" >> analytics-report.md

      - name: Upload analytics report
        uses: actions/upload-artifact@v3
        with:
          name: analytics-report-$(date +%Y%m%d)
          path: analytics-report.md
          retention-days: 30

      - name: Notify analytics completion
        run: |
          echo "ğŸ“Š Analytics report generated successfully on $(date)"
          echo "ğŸ“ˆ Key metrics tracked and analyzed"
          echo "ğŸ“¦ Analytics report uploaded as artifact"
          echo "ğŸ—‚ï¸ Retention period: 30 days"
